<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.hongker.org","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="泽仁&#39;s Blogs">
<meta property="og:url" content="http://blog.hongker.org/index.html">
<meta property="og:site_name" content="泽仁&#39;s Blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Link Sun">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.hongker.org/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>泽仁's Blogs</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">泽仁's Blogs</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Link Sun</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.hongker.org/2024/04/02/%E5%B7%B2%E5%8F%91%E5%B8%83/%E6%B5%85%E8%B0%88%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Link Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/02/%E5%B7%B2%E5%8F%91%E5%B8%83/%E6%B5%85%E8%B0%88%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">浅谈高并发下的,超卖问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-04-02 16:51:07 / Modified: 16:49:19" itemprop="dateCreated datePublished" datetime="2024-04-02T16:51:07+08:00">2024-04-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>浅谈高并发下的,超卖问题</p>
<h4 id="常见易错问题"><a href="#常见易错问题" class="headerlink" title="常见易错问题"></a>常见易错问题</h4><p>更新库存时常用sql如下，但初学者往往会犯下如下错误</p>
<h5 id="问题1-脏数据"><a href="#问题1-脏数据" class="headerlink" title="问题1:脏数据"></a>问题1:脏数据</h5><p>在java代码中计算出库存后再set值<br>此方法<strong>不可取</strong>,很容易会发生并发问题,导致覆盖了库存数量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goods.setNum(goods.getNum()-<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> goods <span class="keyword">set</span> num <span class="operator">=</span> xx <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h5 id="问题2-原子性"><a href="#问题2-原子性" class="headerlink" title="问题2:原子性"></a>问题2:原子性</h5><p><strong>使用sql保证其原子性</strong><br>数据库的排它锁:因为update时会有排它锁,在更新的时,此行会被锁定，只可读不可更新</p>
<blockquote>
<p>如在事务中，则在事务提交前时，其他更新操作将会被阻塞<br>更多update排它锁为何可保证原子性可参考<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/46733729/answer/12858207">阿里mysql大佬给出的update并发解释</a></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> goods <span class="keyword">set</span> num <span class="operator">=</span> num <span class="operator">-</span> <span class="number">1</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>但仍存在超卖即库存可能为0的问题<br>同理，我们仍可以如此来让数据库帮我们做库存判断问题</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> goods <span class="keyword">set</span> num <span class="operator">=</span> num <span class="operator">-</span> <span class="number">1</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> num <span class="operator">&gt;</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>另外需要注意一定要判断update返回的更新行数,如为0则说明未能更新到库存</p>
</blockquote>
<h5 id="问题3-死锁"><a href="#问题3-死锁" class="headerlink" title="问题3:死锁"></a>问题3:死锁</h5><p>上面的问题理论上在事务管理的情况下已经解决了更新库存的原子更新问题，和库存超卖问题</p>
<p>但是在实际运用中，可能仍存在问题:</p>
<p>在事务管理中，当两个线程同时更新A和B两个商品</p>
<ul>
<li>T1线程先更新了A商品，后更新B商品</li>
<li>T2线程先更新了B商品, 后更新A商品</li>
</ul>
<p>而此时如果正好执行在中间，即线程T1持有商品A的互斥锁，线程T2持有商品B的互斥锁，后再去获取另一个商品的互斥锁，这样因互相等待就形成了<strong>死锁</strong><br>这样的结果往往会导致事务超时，或被Spring检测出死锁，使其中一个线程抛出异常中断，另一个线程获得锁执行<br>而这样明显是不友好的</p>
<hr>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>所以我们可以考虑使用其他的<strong>锁</strong>，来保证互斥性<br>能实现锁达到互斥的作用的方法有很多，<br>如java关键字synchronized，jdk中的Lock等<br>但在使用保证护持时需要遵循一个原则:<br><strong>在访问一个共享资源时,锁是唯一的</strong></p>
<blockquote>
<p><strong>在高并发场景中一定要保护好瓶颈资源:数据库</strong></p>
</blockquote>
<h5 id="单机场景"><a href="#单机场景" class="headerlink" title="单机场景"></a>单机场景</h5><p>所以我们应该分场景使用锁<br>如为单机应用的情况下，操作库存的互斥完全可以使用synchronized,CAS原语,Lock等来实现<br>这里建议使用Lock或CAS，来给锁增加一个超时来避免线程死锁</p>
<h5 id="分布式场景"><a href="#分布式场景" class="headerlink" title="分布式场景"></a>分布式场景</h5><p>但在分布式，集群场景时，使用jdk提供的锁就不能保证互斥了，因为不同的虚拟机互相创建的对象是肯定不一样的，所以也就不能达到一把锁的条件</p>
<p>这时可以使用redis来作为分布式锁</p>
<p>网上实现有很多，基本上都是使用setnx语句来设置，如key存在则表明有被锁，而不存在则表明没有被锁</p>
<p>详情实现可以参考<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/dClAHr38z7R-QRNYsb8YtQ">分布式锁用Redis还是Zookeeper</a></p>
<hr>
<blockquote>
<ul>
<li>另外高并发场景，如并发量太高的话，可能是需要消息队列来削峰,减缓服务器压力的</li>
<li>如果想进行并发压测，用apache自带的ab或apache JMeter都是可以的</li>
</ul>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.hongker.org/2024/04/02/Java%E5%A4%9A%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E6%B7%B7%E6%B7%86%E8%B0%83%E7%A0%94/Java%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%AF%86%E8%B0%83%E7%A0%94%207a2483ab35f646799393ff4ceada88ab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Link Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/02/Java%E5%A4%9A%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E6%B7%B7%E6%B7%86%E8%B0%83%E7%A0%94/Java%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%AF%86%E8%B0%83%E7%A0%94%207a2483ab35f646799393ff4ceada88ab/" class="post-title-link" itemprop="url">Java多模块依赖混淆调研</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-04-02 16:51:07 / Modified: 16:50:15" itemprop="dateCreated datePublished" datetime="2024-04-02T16:51:07+08:00">2024-04-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java代码加密调研"><a href="#Java代码加密调研" class="headerlink" title="Java代码加密调研"></a>Java代码加密调研</h1><p>这里先说一下场景</p>
<blockquote>
<p> 公司和甲方签的合同 , 做一款程序,并且维护3年后,甲方可获得项目源码<br>但现在甲方很聪明,不想付维护的钱,但合同里又拥有项目源码的产权<br>现在甲方’违约’ 不想出维护的费用,但项目的钱已经付了,我们还是要给出源码<br>因为我们项目中有部分代码是公司自有产权,并不想直接连这部分一起直接给甲方,于是老板就想我们把这部分代码加密后给甲方,不让甲方获得这部分代码<br>众所周知 java是一款一处编译处处运行的编程语言,编译成class文件后可以让虚拟机识别,但也让反编译工具 十分容易获得其’源码’<br>也就是说我们会提供甲方 <strong>业务代码 源码 和 一些基础依赖的几个jar包</strong></p>
</blockquote>
<p>而业务源码都会依赖于 那些基础jar</p>
<p>目前想到了以下三种方案:</p>
<ol>
<li><p>使用市面上的混淆工具,生成混淆后的jar提供给对方</p>
<blockquote>
<p>常见的也是开发人员大多数使用的方案,最终选择了此种方案</p>
</blockquote>
</li>
<li><p>使用加密工具加密jar包,在业务服务使用时通过秘钥解密后再使用</p>
<blockquote>
<p>因此服务器也是客户的,所以还要把秘钥给对方,其实相当于没有加密,此方案pass</p>
</blockquote>
</li>
<li><p>使用自定义加载器</p>
<blockquote>
<p>实现方式有些复杂,且容易出问题,还要对功能进行全量测试,pass</p>
</blockquote>
</li>
</ol>
<p>经抉择选择方案1, 使用代码混淆工具</p>
<p>这里先定义下混淆工具的工作原理,和混淆的意思<br>混淆会根据引用关系 去动态修改生成的Class文件 包括 包名、类名、变量名 ,甚至是 ,方法体等</p>
<blockquote>
<p>方法体可能会修改循环的实现语句 (使用goto等实现),或者字符串进行一定的编码 等</p>
</blockquote>
<p>这里我调查了几款市面上常用的几款混淆软件</p>
<ol>
<li><p>proguard(有开源免费版本,也有收费的商用版本Professional)</p>
<p> 大多数开发者使用的都是这个版本,但是其没有方法体混淆的功能</p>
</li>
<li><p>allatori (商用收费,支持方法体混淆)</p>
<p> allatori 方法体混淆案例<br> <a target="_blank" rel="noopener" href="https://allatori.com/features/flow-obfuscation.html">https://allatori.com/features/flow-obfuscation.html</a><a target="_blank" rel="noopener" href="https://allatori.com/features/string-encryption.html">https://allatori.com/features/string-encryption.html</a><br> 价格<br> <a target="_blank" rel="noopener" href="https://allatori.com/price.html">https://allatori.com/price.html</a></p>
</li>
<li><p>Dasho(商用收费,支持方法体混淆)</p>
<p> 方法体混淆案例<br> <a target="_blank" rel="noopener" href="https://www.preemptive.com/products/dasho/features/">https://www.preemptive.com/products/dasho/features/</a><br> 价格售卖<br> <a target="_blank" rel="noopener" href="https://www.preemptive.com/products/dasho/pricing/">https://www.preemptive.com/products/dasho/pricing/</a><br> 这个得去官网申请,貌似有免费试用,不过也得先在官网提交申请</p>
</li>
<li><p>使用 开源学习版 allatori,直接对可执行jar 进行混淆</p>
<p> <a target="_blank" rel="noopener" href="https://github.com/lqs1848/AllatoriCrack.git">https://github.com/lqs1848/AllatoriCrack.git</a></p>
<p> 使用此项目 编译成功并加密成功后,总会报</p>
<p> <code>java.lang.NoClassDefFoundError</code> 但反编译后此类又与原未加密可运行的包基本一样的,无奈只好放弃此方案</p>
</li>
</ol>
<p><img src="/Java%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%AF%86%E8%B0%83%E7%A0%94%207a2483ab35f646799393ff4ceada88ab/Untitled.png" alt="Untitled"></p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li>proguard 官网地址</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.guardsquare.com/manual/quickstart#maven-project">https://www.guardsquare.com/manual/quickstart#maven-project</a></p>
<ul>
<li>proguard 官网github 文档地址</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://wvengen.github.io/proguard-maven-plugin/">https://wvengen.github.io/proguard-maven-plugin/</a></p>
<ul>
<li>多模块springboot混淆参考</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34250494/article/details/122987426">https://blog.csdn.net/qq_34250494&#x2F;article&#x2F;details&#x2F;122987426</a></p>
<ul>
<li>配置项document</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903474740592647">https://juejin.cn/post/6844903474740592647</a></p>
<ul>
<li>官方推荐博客</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.sobyte.net/post/2021-11/use-proguard-maven-plugin-to-obfuscate-the-spring-boot-program/">https://www.sobyte.net/post/2021-11/use-proguard-maven-plugin-to-obfuscate-the-spring-boot-program/</a></p>
<h2 id="疑难杂症"><a href="#疑难杂症" class="headerlink" title="疑难杂症"></a>疑难杂症</h2><h3 id="META-INF目录内容丢失"><a href="#META-INF目录内容丢失" class="headerlink" title="META-INF目录内容丢失"></a>META-INF目录内容丢失</h3><p>打包后 META-INF 目录下的只剩一些空包，设置了 <code>dontshrink</code>  但仍然被删除了代码</p>
<p>解决方案:</p>
<p>注意 proguard 插件 和打包的插件是有先后顺序关系的, 即 pom.xml <plugins> 标签下 虽然通常情况下不需要注意顺序问题，但是如果这里需要使用 spring-boot打包插件和 proguard 插件一起时，则必须在spring-boot打包插件之前 执行proguard 混淆,如下配置</p>
<p>proguard 插件需要定义在 spring-boot-maven-plugin 之前</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.wvengen<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>proguard-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>proguard<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">proguardVersion</span>&gt;</span>6.2.2<span class="tag">&lt;/<span class="name">proguardVersion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">injar</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">injar</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outjar</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">outjar</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">obfuscate</span>&gt;</span>true<span class="tag">&lt;/<span class="name">obfuscate</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">proguardInclude</span>&gt;</span>$&#123;project.basedir&#125;/proguard.cfg<span class="tag">&lt;/<span class="name">proguardInclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">libs</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- Include main JAVA library required.--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">lib</span>&gt;</span>$&#123;java.home&#125;/lib/rt.jar<span class="tag">&lt;/<span class="name">lib</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- Include crypto JAVA library if necessary.--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">lib</span>&gt;</span>$&#123;java.home&#125;/lib/jce.jar<span class="tag">&lt;/<span class="name">lib</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">libs</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">assembly</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">inclusions</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--依赖的子模块，打包在一起形成一个jar进行代码混淆--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework-external<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework-fastreport<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-data-persistent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">inclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.proguard<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>proguard-base<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">layers</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">layers</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework-external<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-data-persistent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="NoSuchMethodError异常"><a href="#NoSuchMethodError异常" class="headerlink" title="NoSuchMethodError异常"></a><code>NoSuchMethodError</code>异常</h3><p>当出现这个异常时, 很可能是 使用了 <code>-keep</code> 配置,忽略了某些类,使其不进行混淆,但是未被混淆的类可能依赖了某些混淆了的类,因为混淆后方法名称可能变更了,所以导致找不到这个方法了</p>
<p>解决方案: 尽量不要使用<code>-keep</code> 命令配置,可以使用 <code>keepclassmembers</code> 替代</p>
<p>且在配置pom文件时,最好也将其依赖的其他模块module也一起打包</p>
<p>即: 如下配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">assembly</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">inclusions</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--依赖的子模块，打包在一起形成一个jar进行代码混淆--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">inclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">layers</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">layers</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>参考文章</strong></p>
<p><img src="/Java%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%AF%86%E8%B0%83%E7%A0%94%207a2483ab35f646799393ff4ceada88ab/Untitled%201.png" alt="Untitled"></p>
<h3 id="spring-boot多模块应用，混淆依赖lib-jar"><a href="#spring-boot多模块应用，混淆依赖lib-jar" class="headerlink" title="spring-boot多模块应用，混淆依赖lib jar"></a>spring-boot多模块应用，混淆依赖lib jar</h3><p>当使用 proguard 打包 混淆时，默认会将当前 项目混淆，而不会去混淆包依赖的jar</p>
<p>也就是如下，仅会混淆class目录下的内容，不会混淆lib目录</p>
<ul>
<li>BOOT-INF<ul>
<li>classes<ul>
<li>xxx</li>
</ul>
</li>
<li>lib<ul>
<li>xxxx.jar</li>
</ul>
</li>
</ul>
</li>
<li>META-INF</li>
</ul>
<p><img src="/Java%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%AF%86%E8%B0%83%E7%A0%94%207a2483ab35f646799393ff4ceada88ab/Untitled%202.png" alt="Untitled"></p>
<p>这里有两种方案</p>
<ol>
<li>将 依赖jar和当前项目和指定依赖 合并当作一个 <code>artifact</code> 打包，</li>
<li>使用 proguard 集成的 <code>assembly</code> ，即 proguard有帮你集成此功能，推荐此方法</li>
</ol>
<p>使用方法如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">assembly</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">inclusions</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--依赖的子模块，打包在一起形成一个jar进行代码混淆--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xxx.aaa<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxx-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xxx.aaa<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxx-framework-external<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">inclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是这种方法会在打包后，lib包中仍然包含了未混淆的原始包，我的解决方案是如下，在spring-boot-maven-plugin 打包时，剔除依赖包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xxx.aaa<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxx-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xxx.aaa<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxx-framework-external<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="重复创建beanName-暂未用上"><a href="#重复创建beanName-暂未用上" class="headerlink" title="重复创建beanName (暂未用上)"></a>重复创建beanName (暂未用上)</h3><p>当有重复引入依赖时，spring-boot启动会报错，提示beanName重复，可以使用如下配置覆盖beand定义</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 允许重复创建bean</span><br><span class="line">spring.main.allow-bean-definition-overriding=true</span><br></pre></td></tr></table></figure>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>需要注意，混淆时会把类的名称，方法都改掉，如果这个class和外部交互有关(如 swagger 反射生成文档，配置中心反射序列化bean)， 则此时最好不要 <code>keep</code> 掉这些类，避免产生问题</p>
<h2 id="完整配置附录"><a href="#完整配置附录" class="headerlink" title="完整配置附录"></a>完整配置附录</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.wvengen<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>proguard-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>proguard<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">proguardVersion</span>&gt;</span>6.2.2<span class="tag">&lt;/<span class="name">proguardVersion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">injar</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">injar</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">outjar</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">outjar</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">obfuscate</span>&gt;</span>true<span class="tag">&lt;/<span class="name">obfuscate</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">proguardInclude</span>&gt;</span>$&#123;project.basedir&#125;/proguard.cfg<span class="tag">&lt;/<span class="name">proguardInclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">libs</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- Include main JAVA library required.--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">lib</span>&gt;</span>$&#123;java.home&#125;/lib/rt.jar<span class="tag">&lt;/<span class="name">lib</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- Include crypto JAVA library if necessary.--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">lib</span>&gt;</span>$&#123;java.home&#125;/lib/jce.jar<span class="tag">&lt;/<span class="name">lib</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">libs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">assembly</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">inclusions</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!--依赖的子模块，打包在一起形成一个jar进行代码混淆--&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework-external<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework-fastreport<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-data-persistent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">inclusion</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">inclusions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.proguard<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>proguard-base<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">layers</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">layers</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-framework-external<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.candao.iddc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>candao-iddc-data-persistent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁用压缩</span></span><br><span class="line">-dontshrink</span><br><span class="line"><span class="comment"># 方法字节级优化</span></span><br><span class="line">-dontoptimize</span><br><span class="line">-useuniqueclassmembernames</span><br><span class="line">-adaptclassstrings</span><br><span class="line">-keepattributes Exceptions, InnerClasses, Signature, Deprecated, SourceFile, LineNumberTable, *Annotation*, EnclosingMethod, Module</span><br><span class="line">-keepnames interface **</span><br><span class="line">-keepparameternames</span><br><span class="line">-keep class *  &#123; public static void main(java.lang.String[]); &#125;</span><br><span class="line"></span><br><span class="line">-keep class com.candao.iddc.persistent.** &#123;</span><br><span class="line">    *;</span><br><span class="line">&#125;</span><br><span class="line">-keep interface * extends * &#123; *; &#125;</span><br><span class="line">-keep class com.candao.iddc.business.flow.** &#123;*;&#125;</span><br><span class="line"></span><br><span class="line">-keeppackagenames com.candao.iddc</span><br><span class="line">-keeppackagenames com.candao.iddc.persistent.business</span><br><span class="line">-keeppackagenames com.candao.iddc.persistent.report</span><br><span class="line"></span><br><span class="line">-keepdirectories</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不混淆native方法</span></span><br><span class="line">-keepclasseswithmembernames class * &#123; native &lt;methods&gt;; &#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers class * &#123;</span><br><span class="line">    @org.springframework.beans.factory.annotation.Qualifier *;</span><br><span class="line">    @org.springframework.beans.factory.annotation.Autowired *;</span><br><span class="line">    @org.springframework.beans.factory.annotation.Value *;</span><br><span class="line">    @org.springframework.context.annotation.EnableAspectJAutoProxy *;</span><br><span class="line">    @org.springframework.context.annotation.ComponentScan *;</span><br><span class="line">    @org.springframework.context.annotation.Bean *;</span><br><span class="line">    @org.springframework.context.annotation.Configuration *;</span><br><span class="line">    @org.springframework.stereotype.Service *;</span><br><span class="line">    @org.springframework.stereotype.Component *;</span><br><span class="line">    @org.springframework.stereotype.Repository *;</span><br><span class="line">    @org.springframework.web.bind.annotation.RestController *;</span><br><span class="line">    @org.springframework.validation.annotation.Validated *;</span><br><span class="line">&#125;</span><br><span class="line">-keepclassmembernames class com.candao.iddc.*.controller.** &#123; *;&#125;</span><br><span class="line">-keepclassmembernames class com.candao.iddc.framework.core.** &#123;*;&#125;</span><br><span class="line">-keepclassmembernames class * implements com.candao.iddc.framework.core.base.BaseEntity &#123; *; &#125;</span><br><span class="line">-keepclassmembernames class com.candao.iddc.**.bean.** &#123;*;&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembernames class * &#123;</span><br><span class="line">            void <span class="built_in">set</span>*(***);</span><br><span class="line">            boolean is*();</span><br><span class="line">            *** get*();</span><br><span class="line">        &#125;</span><br><span class="line">-keepclassmembers enum * &#123; *; &#125;</span><br><span class="line">-ignorewarnings</span><br><span class="line">-printconfiguration</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保留所有静态public方法</span></span><br><span class="line"><span class="comment">#-keepclassmembers class com.example.** &#123; public static &lt;methods&gt;; &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="打包报错"><a href="#打包报错" class="headerlink" title="打包报错"></a>打包报错</h3><p>proguard 打包报错 (Can’t process class [module-info.class] (Unsupported class version number [53.0] (maximum 52.0, Java 1.8)))</p>
<p>需要升级 插件版本为 6.2.2</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">proguardVersion</span>&gt;</span>6.2.2<span class="tag">&lt;/<span class="name">proguardVersion</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.proguard<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>proguard-base<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>总结一下这次混淆打包</p>
<p>最终打包效果: 将 business + report +external 三个业务模块 和其他几个framework</p>
<ol>
<li>混淆时需要将<strong>所有依赖的模块一起混淆</strong>,(因为插件只会混淆当前模块,injar,不会去混淆lib包,可能可以设置多个injar 不过没有继续尝试)</li>
<li><strong>injar 和outjar 配置最好是一样的</strong> ,如果配置不一样则不会自动压缩,将依赖打入同一个包内</li>
<li><strong>混淆插件版本不能太低</strong>,太低会报错,不支持打包spring-boot项目</li>
<li><strong>不要使用过多的keep参数</strong>,否则 当被keep的类依赖了被混淆的类时,会出现错误</li>
<li><strong>spring-boot 多模块打包</strong>时,需要使用 assembly 插件配置,和spring-boot-maven-plugin也需要做一点修改,排除 excludes framework包,避免未加密的包被打包进lib</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.hongker.org/2024/04/02/FastJson%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E5%8F%8A%E9%87%8D%E7%8E%B0%E8%BF%87%E7%A8%8B/Fastjson%E4%BC%98%E5%8C%96%207c2cb0d6c29f4cd28566e8bd9973d389/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Link Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/02/FastJson%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E5%8F%8A%E9%87%8D%E7%8E%B0%E8%BF%87%E7%A8%8B/Fastjson%E4%BC%98%E5%8C%96%207c2cb0d6c29f4cd28566e8bd9973d389/" class="post-title-link" itemprop="url">FastJson漏洞修复及重现过程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-04-02 16:51:07 / Modified: 16:50:38" itemprop="dateCreated datePublished" datetime="2024-04-02T16:51:07+08:00">2024-04-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Fastjson优化"><a href="#Fastjson优化" class="headerlink" title="Fastjson优化"></a>Fastjson优化</h1><p>status: Testing<br>Created: August 9, 2021 3:35 PM</p>
<p>因目前IRMS使用的fastjson版本较低，存在多个高危漏洞，故决定升级fastjson到目前的最新的发布版本 <strong>1.2.76</strong> </p>
<h3 id="主要影响漏洞"><a href="#主要影响漏洞" class="headerlink" title="主要影响漏洞"></a>主要影响漏洞</h3><p>fastjson的<code>@type</code>漏洞,攻击者可向目标服务器发起攻击json请求,当目标服务器反序列化该攻击json串时,则会引发反序列化漏洞,实现挂载恶意java类,达到攻击目的</p>
<p><strong>Fastjson反序列化漏洞被利用的原因，可以归结为两方面：</strong></p>
<ol>
<li>Fastjson提供了反序列化功能，允许用户在输入JSON串时通过“@type”键对应的value指定任意反序列化类名；</li>
<li>Fastjson自定义的反序列化机制会使用反射生成上述指定类的实例化对象，并自动调用该对象的setter方法及部分getter方法。</li>
</ol>
<blockquote>
<p>攻击者可以构造恶意请求，使目标应用的代码执行流程进入这部分特定setter或getter方法，若上述方法中有可被恶意利用的逻辑（也就是通常所指的“Gadget”），则会造成一些严重的安全问题。</p>
</blockquote>
<p>目前irms使用版本</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.41<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>准备升级到最新版本</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.76<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="涉及服务"><a href="#涉及服务" class="headerlink" title="涉及服务"></a>涉及服务</h3><p>因依赖fastjson的为底层基础服务 <strong>irms-log</strong></p>
<p><strong>irms-framework 引用了irms-log，所以基本上所有在使用的irms服务均受影响</strong></p>
<h3 id="其他代码变动"><a href="#其他代码变动" class="headerlink" title="其他代码变动"></a>其他代码变动</h3><p>配置变动</p>
<p>因升级1.2.76 版本后，fastjson中的</p>
<p>com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter#FastJsonHttpMessageConverter</p>
<p>类构造器发生变动 supportedMediaType 为ALL了</p>
<p>导致feign调用时无法通过安全验证</p>
<p>修改了如下配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * json数据转换器</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> HttpMessageConverters <span class="title function_">fastJsonHttpMessageConverters</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">FastJsonHttpMessageConverter</span> <span class="variable">fastConvert</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastJsonHttpMessageConverter</span>();</span><br><span class="line"></span><br><span class="line">		fastConvert.setFeatures(SerializerFeature.PrettyFormat,</span><br><span class="line">					SerializerFeature.WriteNullStringAsEmpty,</span><br><span class="line">					SerializerFeature.WriteNullNumberAsZero,</span><br><span class="line">					SerializerFeature.WriteNullBooleanAsFalse);</span><br><span class="line">		fastConvert.setSupportedMediaTypes(supportedMediaTypes());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpMessageConverters</span>((HttpMessageConverter&lt;?&gt;) fastConvert);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * HttpMessageConverters 支持的消息类型</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 执行的消息类型</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> List&lt;MediaType&gt; <span class="title function_">supportedMediaTypes</span><span class="params">()</span> &#123;</span><br><span class="line">		List&lt;MediaType&gt; supportedMediaTypes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		supportedMediaTypes.add(<span class="keyword">new</span> <span class="title class_">MediaType</span>(<span class="string">&quot;application&quot;</span>, <span class="string">&quot;json&quot;</span>, StandardCharsets.UTF_8));</span><br><span class="line">		<span class="keyword">return</span> supportedMediaTypes;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>主要是增加了setSupportedMediaTypes()关键代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastConvert.setSupportedMediaTypes(supportedMediaTypes());</span><br></pre></td></tr></table></figure>

<ul>
<li><input disabled="" type="checkbox"> <strong>浮点类型转换兼容问题</strong></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.notion.so/cb06daf8cf044182a6f7f0a42840216b?pvs=21">集合类型反序列化运行时异常</a></p>
<p><a target="_blank" rel="noopener" href="https://www.notion.so/null-c3277cc0de4c43c493c31983d5579b67?pvs=21">反序列化对象字符字段null变成””</a></p>
<p><a target="_blank" rel="noopener" href="https://www.notion.so/FastJson-e89effcf684d4c7ebb514d1a174eba4b?pvs=21">FastJson攻击步骤</a></p>
<p>FastJson升级后可能导致了 Feign调用后，如果 对象的 Long类型 为null会自动转为 0</p>
<p>参考代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.candao.irms.report.controller.ReportInnerController#saveOrderDeliveryRiderType</span><br></pre></td></tr></table></figure>

<h3 id="开启fastJson-safeModel"><a href="#开启fastJson-safeModel" class="headerlink" title="开启fastJson safeModel"></a>开启fastJson safeModel</h3><blockquote>
<p>在1.2.68之后的版本，在1.2.68版本中，fastjson增加了safeMode的支持。safeMode打开后，完全禁用autoType。所有的安全修复版本sec10也支持SafeMode配置。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/wiki/fastjson_safemode?spm=a2c4g.11174386.n2.4.6ebb4c07UQTk4S">https://github.com/alibaba/fastjson/wiki/fastjson_safemode?spm&#x3D;a2c4g.11174386.n2.4.6ebb4c07UQTk4S</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.hongker.org/2024/04/01/mysql%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B0/Sharding-JDBC=Note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Link Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/mysql%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B0/Sharding-JDBC=Note/" class="post-title-link" itemprop="url">Sharding-JDBC</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-04-01 21:57:24 / Modified: 21:11:47" itemprop="dateCreated datePublished" datetime="2024-04-01T21:57:24+08:00">2024-04-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h1><p>是当当网提供开源的,目前已为并入apache下</p>
<p>其可以做到仅通过配置,而无代码侵入的情况下实现 分库分表</p>
<p>其关键在于配置分库分表规则</p>
<h4 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h4><ol>
<li>解析sql,获取片键值</li>
<li>sJDBC 通过配置的库策略,表,来判断sql往哪个库,哪个表来发出请求操作</li>
<li>sJDBC 改写逻辑表名sql,为真正要执行的sql</li>
<li>sJDBC执行真正的sql</li>
<li>sJDBC汇总sql执行结果</li>
</ol>
<h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><p>查询中,如果有 in,id中包含多个不同的库,则sjdbc会将sql拆分为访问不同库或表的sql,再将结果组合到一起</p>
<h4 id="绑定表"><a href="#绑定表" class="headerlink" title="绑定表"></a>绑定表</h4><p><strong>指分片键完全相同,则此两张表互为绑定关系</strong></p>
<p>如非绑定表关系,则在join查询时,会出现笛卡尔积关联</p>
<p>如 <code>t_order</code> 和 <code>t_order_item</code> , <code>t_order_item</code> 和 <code>t_order</code> 是多对一的关系</p>
<h4 id="广播表"><a href="#广播表" class="headerlink" title="广播表"></a>广播表</h4><p>指所有分片数据源中都存在的表,表结构和表中数据在每个数据库中均完全一致,适用于数据量不大,且需要与海量数据关联查询的场景,如字典表</p>
<h4 id="SQL执行-连接模式"><a href="#SQL执行-连接模式" class="headerlink" title="SQL执行,连接模式"></a>SQL执行,连接模式</h4><p>sJDBC采用一套自动化的执行引擎,负责将路由和改写完的真实sql安全且高效发送到底层数据源执行。</p>
<p>它不是简单地将SQL通过jdbc直接发送至数据源执行,也并非直接将执行请求放入线程池去并发执行。</p>
<p>它更关注平衡数据源连接创建及内存占用所产生的消耗,以及最大限度地利合理利用并发等问题。</p>
<p>执行引擎的目标是自动化的平衡资源控制与执行效率,他能在以下两种模式自适应切换</p>
<h5 id="内存限制模式"><a href="#内存限制模式" class="headerlink" title="内存限制模式"></a>内存限制模式</h5><p>sJDBC,对一次操作所耗费的数据库连接不做限制。</p>
<p>如果实际执行的sql需要对某数据库实例中的200张表做操作,则对每张表创建一个新的数据库连接,并通过多线程的方式并发处理,追求执行效率的最大化</p>
<h5 id="连接限制模式"><a href="#连接限制模式" class="headerlink" title="连接限制模式"></a>连接限制模式</h5><p>严格限制sJDBC所耗费的数据库连接数量,如实际执行的sql需要对某数据库实例中的200张表做操作,那么只会创建唯一的数据库连接并对200张表进行串行处理</p>
<p>如果一次操作中的分片散落在不同的数据库中,仍然采用多线程对不同库的操作,但每个库的每次操作仍然只创建一个数据库连接</p>
<p><strong>内存限制模式适用于OLAP应用,连接限制模式适用于OLTP应用</strong></p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><h5 id="打开日志输出"><a href="#打开日志输出" class="headerlink" title="打开日志输出"></a>打开日志输出</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 打开 sharding-jdbc解析sql日志</span><br><span class="line">spring.shardingsphere.props.sql.show=true</span><br></pre></td></tr></table></figure>



<h5 id="如何分页"><a href="#如何分页" class="headerlink" title="如何分页"></a>如何分页</h5><p>分页如果查询条件未加分片键,则会扫描所有的数据库和表,并汇总结果</p>
<p>分页为了保证顺序,会查询各个表的前n条数据</p>
<p>如: 分页查询,每页十条数据,第三页, sql 语句为  <code>limit (3-1) * 10, 10</code></p>
<p>sharding-jdbc会扫描每个需要查询表的前30条数据,如这次查询有关联三个表</p>
<p>则总共查询了 30 * 3条数据,并取前 10条,为汇总结果</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.hongker.org/2024/04/01/mysql%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B0/InnoDB%E6%8A%80%E6%9C%AF%E7%82%B9%E6%80%BB%E7%BB%93(%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%E4%B8%AD)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Link Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/mysql%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B0/InnoDB%E6%8A%80%E6%9C%AF%E7%82%B9%E6%80%BB%E7%BB%93(%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%E4%B8%AD)/" class="post-title-link" itemprop="url">InnoDB技术点总结(持续更新中)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-01 21:57:24" itemprop="dateCreated datePublished" datetime="2024-04-01T21:57:24+08:00">2024-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-10-19 18:19:54" itemprop="dateModified" datetime="2020-10-19T18:19:54+08:00">2020-10-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="redo-log-重做日志"><a href="#redo-log-重做日志" class="headerlink" title="redo log:重做日志"></a>redo log:重做日志</h3><p>当前数据库系统普遍都采用了 Write Ahead Log（写前先写日志）策略<br>即:<strong>当事务提交时,先写重做日志,再修改页</strong></p>
<p><strong>重做日志在以下三种情况下会从日志缓存中刷新到外部磁盘的重做日志文件中</strong></p>
<ul>
<li>Master Thread每秒将重做日志缓冲刷新到重做日志中</li>
<li>每个事务提交时会抽将重做日志刷新到重做日志文件中</li>
<li>当重做日志缓冲池剩余空间小于1&#x2F;2时,重做日志缓冲刷新到重做日志文件</li>
</ul>
<h3 id="Checkpoint技术"><a href="#Checkpoint技术" class="headerlink" title="Checkpoint技术"></a>Checkpoint技术</h3><p><strong>Checkpoint所做的事情无外乎就是将缓存池中的脏页刷回到磁盘</strong></p>
<p>不同之处在于每次刷新多少页到磁盘,每次从那里取脏页,以及什么时间出发Checkpoint</p>
<p>Checkpoint(检查点)技术的目的是解决以下几个问题</p>
<ul>
<li>缩短数据库的恢复时间</li>
<li>缓冲池不够用时,将脏吔刷新到磁盘</li>
<li>重做日志不可用时,刷新脏页</li>
</ul>
<h3 id="Master-Thread工作方式"><a href="#Master-Thread工作方式" class="headerlink" title="Master Thread工作方式"></a>Master Thread工作方式</h3><p>MasterThread具有最高的线程优先级别,其内部由多个循环组成</p>
<ol>
<li>主循环(loop)</li>
<li>后台循环(backgroup loop)</li>
<li>刷新循环(flush loop)</li>
<li>暂停循环(suspend loop)</li>
</ol>
<h4 id="每秒一次的操作包括："><a href="#每秒一次的操作包括：" class="headerlink" title="每秒一次的操作包括："></a>每秒一次的操作包括：</h4><ul>
<li>日志缓冲刷新到磁盘，即使这个事务还没有提交（总是）；</li>
<li>合并插入缓冲（可能）；</li>
<li>至多刷新100个InnoDB的缓冲池中的脏页到磁盘（可能）；</li>
<li>如果当前没有用户活动，则切换到background loop（可能）。<br><strong>即使某个事务还没有提交，InnoDB存储引擎仍然每秒会将重做日志缓冲中的内容刷新到重做日志文件</strong>。这一点是必须要知道的，因为这可以很好地解释为什么再大的事务提交（commit）的时间也是很短的。</li>
</ul>
<h4 id="每10秒的操作，包括如下内容："><a href="#每10秒的操作，包括如下内容：" class="headerlink" title="每10秒的操作，包括如下内容："></a>每10秒的操作，包括如下内容：</h4><ul>
<li>刷新100个脏页到磁盘（可能的情况下）；</li>
<li>合并至多5个插入缓冲（总是）；</li>
<li>将日志缓冲刷新到磁盘（总是）；</li>
<li>删除无用的Undo页（总是）；</li>
<li>刷新100个或者10个脏页到磁盘（总是）。</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p><strong>综上:MasterThread主要任务有</strong> </p>
<ol>
<li><strong>将日志刷新到磁盘</strong></li>
<li><strong>合并插入缓冲</strong></li>
<li><strong>刷新脏页到磁盘</strong></li>
<li><strong>删除无用的Undo页</strong></li>
<li><strong>当没有用户活动时挂起线程</strong></li>
</ol>
<blockquote>
<p>在Innodb版本后续的更新中(1.2.x)，刷新脏页的操作从Master Thread线程中分离到了一个单独的Page Cleaner Thread中，<br>从而减轻了MasterThread的工作，进一步提高了系统的并发性</p>
</blockquote>
<h3 id="InnoDB关键特性"><a href="#InnoDB关键特性" class="headerlink" title="InnoDB关键特性"></a>InnoDB关键特性</h3><h4 id="插入缓冲-Insert-Buffer"><a href="#插入缓冲-Insert-Buffer" class="headerlink" title="插入缓冲(Insert Buffer)"></a>插入缓冲(Insert Buffer)</h4><h4 id="两次写-Double-Write"><a href="#两次写-Double-Write" class="headerlink" title="两次写(Double Write)"></a>两次写(Double Write)</h4><h4 id="自适应哈希索引-Adaptive-Hash-Index"><a href="#自适应哈希索引-Adaptive-Hash-Index" class="headerlink" title="自适应哈希索引(Adaptive Hash Index)"></a>自适应哈希索引(Adaptive Hash Index)</h4><ul>
<li><p>InnoDB会<strong>根据访问评率和访问模式来自动地为某些热点页来简历哈希索引</strong></p>
<p>其设计思想是数据库自由化的(self-tuning),即无需DBA对数据库进行认为调整</p>
</li>
<li><p>AHI的建立有一个条件,即对这个页的连续访问模式必须是一样的</p>
</li>
<li><p>AHI默认为开启状态</p>
</li>
</ul>
<blockquote>
<p>访问模式:即查询条件</p>
<p>where a &#x3D; xx</p>
<p>where a &#x3D; xx and b&#x3D;xxx</p>
<p>以上就是访问模式不一样</p>
</blockquote>
<h4 id="异步IO-Async-IO"><a href="#异步IO-Async-IO" class="headerlink" title="异步IO(Async IO)"></a>异步IO(Async IO)</h4><p>  如果用户发出的是一条索引扫描的查询,那么这条sql查询语句可能需要扫描多个索引页,也就是需要进行多次的IO操作,在每扫描一个页并等待其完成后在进行下一次扫描,这是没有必要的。</p>
<p>  用户可以再发出一个IO请求后立即在发出另一个IO请求,等待所有IO操作的完成,这就是AIO(Async IO)</p>
<blockquote>
<p>在InnoDB存储引擎中,read ahead方式的读取都是通过AIO完成,脏页的刷新,即磁盘的写入操作则全部由AIO完成</p>
</blockquote>
<h4 id="刷新邻接页-Flush-Neighbor-Page"><a href="#刷新邻接页-Flush-Neighbor-Page" class="headerlink" title="刷新邻接页(Flush Neighbor Page)"></a>刷新邻接页(Flush Neighbor Page)</h4><p>其工作原理为:当刷新一个脏页时,InnoDB存储引擎会检测该页所载区(Extent)的所有页,如果是脏页,那么一起刷新,这样做的好处显而易见,通过AIO可以将多个IO写入合并为一个IO操作,故该工作机制在传统机械磁盘下有着显著的优势</p>
<p>InnoDB存储引擎从1.2x版本提供了参数 Innodb_flush_neighbors,可以控制是否启用此特性</p>
<blockquote>
<p>对于固态硬盘,因其有着超高的IOPS性能的磁盘,建议将该参数设置为0,即关闭此特性</p>
<p>而传统机械硬盘则建议启用该特性</p>
</blockquote>
<h4 id="启动恢复与关闭"><a href="#启动恢复与关闭" class="headerlink" title="启动恢复与关闭"></a>启动恢复与关闭</h4><p>InnoDB是MySQL是巨亏的存储引擎之一,因此InnoDB存储引擎的启动和关闭,更准确的是指在MySQL实例的启动过程中对InnoDB存储引擎的处理过程</p>
<h5 id="设置关闭行为"><a href="#设置关闭行为" class="headerlink" title="设置关闭行为"></a>设置关闭行为</h5><p>在关闭时,参数 innodb_fast_shutdown影响着表的存储引擎为InnoDB的行为,改参数可取值为0,1,2,默认为1</p>
<ol start="0">
<li><p>表示在关闭Mysql数据库时,完成所有的 full purge 和merge insert buffer,并且刷新所有脏页到磁盘,这可能需要一段时间</p>
<p>如果在进行InnoDB升级时,必须将这个参数调为0,然后再关闭数据库</p>
</li>
<li><p>默认值,表示不进行 full purge 和merge insert buffer操作,但还是会刷新所有脏页到磁盘</p>
</li>
<li><p>表示不完成full purge 和merge insert buffer操作,也不会刷新脏页到磁盘,而是会记录日志,在下次启动时候,会进行恢复操作</p>
</li>
</ol>
<h5 id="设置启动恢复行为"><a href="#设置启动恢复行为" class="headerlink" title="设置启动恢复行为"></a>设置启动恢复行为</h5><p>参数 innodb_force_recovery影响了,数据库实例启动时的恢复数据行为<br>默认为0,代表当发生需要恢复时,进行所有的恢复操作,还可设置为6个非0值:1~6</p>
<ol>
<li>（SRV_FORCE_IGNORE_CORRUPT）：忽略检查到的corrupt页。</li>
<li>（SRV_FORCE_NO_BACKGROUND）：阻止Master Thread线程的运行，如Master Thread线程需要进行full purge操作，而这会导致crash。</li>
<li>（SRV_FORCE_NO_TRX_UNDO）：不进行事务的回滚操作。</li>
<li>（SRV_FORCE_NO_IBUF_MERGE）：不进行插入缓冲的合并操作。</li>
<li>（SRV_FORCE_NO_UNDO_LOG_SCAN）：不查看撤销日志（Undo Log），InnoDB存储引擎会将未提交的事务视为已提交。</li>
<li>（SRV_FORCE_NO_LOG_REDO）：不进行前滚的操作。</li>
</ol>
<h3 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h3><p>日志文件记录了影响mysql数据库各种类型活动。MySQL中常见的日志文件有:</p>
<ol>
<li>错误日志（error log）</li>
<li>二进制日志（binlog）</li>
<li>慢查询日志（slow query log）</li>
<li>查询日志（log）</li>
</ol>
<h4 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h4><p>使用如下命令来查看错误日志所在地址</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;log_error&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当数据库启动失败时,应当首先查看该日志</p>
<p>错误日志中,可能还会出现警告,比如告诉用户需要增大innoDB存储引擎的redo log,</p>
</blockquote>
<h4 id="慢查询日志-slow-log"><a href="#慢查询日志-slow-log" class="headerlink" title="慢查询日志(slow log)"></a>慢查询日志(slow log)</h4><h5 id="开启-查看慢查询日志"><a href="#开启-查看慢查询日志" class="headerlink" title="开启,查看慢查询日志"></a>开启,查看慢查询日志</h5><p>使用<code>SHOW VARIABLES LIKE &#39;slow_query_log&#39;;</code> 或<code>SHOW VARIABLES LIKE &#39;log_slow_queries&#39;;</code>可以查看是否开启慢查询日志,</p>
<p>如未开启,则可以去my.cnf中配置开启</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 阈值,大于这个值时,才会记录慢查询日志</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;long_query_time&#x27;</span>;</span><br><span class="line"><span class="comment">-- 旧版mysql 查看是否开启慢查询参数</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_slow_queries&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看慢查询是否开启</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slow_query_log%&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h5 id="记录未使用索引sql"><a href="#记录未使用索引sql" class="headerlink" title="记录未使用索引sql"></a>记录未使用索引sql</h5><p>另外慢查询相关的还有两个参数</p>
<p><code>log_queries_not_using_indexes</code></p>
<p>是否开启未使用索引慢日志记录</p>
<p><code>log_throttle_queries_not_using_indexes</code></p>
<p>表示每分钟允许记录到slow log的且未使用索引的sql语句次数:默认为0,代表不限制</p>
<blockquote>
<p>默认情况下,mysql不会开启慢查询日志(超过时间的查询,未使用索引)</p>
<p>生产环境下若没有使用索引,未经过节流配置,则可能导致 slow_log不断增加,开启节流配置即可</p>
</blockquote>
<h5 id="慢查询分析命令"><a href="#慢查询分析命令" class="headerlink" title="慢查询分析命令"></a>慢查询分析命令</h5><p>另外个慢查询日志越来越大越来越多时,可以参考使用mysql提供的命令<code>mysqldumpslow</code></p>
<p>eg: 如果用户希望得到执行时间最长的10条sql语句,可以允许如下命令</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow <span class="operator">-</span>s al <span class="operator">-</span>n xxx.log</span><br></pre></td></tr></table></figure>



<p>另外在mysql架构下，慢查询日志对应表 <code>mysql.slow_log</code> 表</p>
<p>可用此值来查看输出类型,默认为FILE,可以改为 TABLE,这样慢查询日志就会直接写进 <code>slow_log</code>表了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_output&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>log_output 此值是动态的,因此可以在数据库允许时修改此参数</p>
</blockquote>
<p><strong>需要注意的时,开启慢查询还是会对数据库有一定的额外开销,不过好在慢查询日志的参数大多都是动态的,可线上方便修改</strong></p>
<h4 id="查询日志-general-log"><a href="#查询日志-general-log" class="headerlink" title="查询日志(general log)"></a>查询日志(general log)</h4><p>查询日志记录了所有对mysql数据库的请求信息,物流这些请求是否得到了正确的执行(如就算权限不足执行sql,也会被记录下来)</p>
<p>默认没有开启,可以使用如下命令查看和开启</p>
<p>查看启用状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;general_log&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>设置开启</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">global</span>  general_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>其对应的mysql架构的表为  <code>mysql.general_log</code> 表</p>
<p>使用方式同上慢查询日志,不再赘述</p>
<h4 id="二进制日志-binary-log"><a href="#二进制日志-binary-log" class="headerlink" title="二进制日志(binary log)"></a>二进制日志(binary log)</h4><p>二进制日志(binary log) 记录了对MySQL数据库执行更改的所有操作,但是不包含select和show这类操作,有时候 update可能并没有受影响行数,但也会被binary log记录</p>
<h5 id="功能作用"><a href="#功能作用" class="headerlink" title="功能作用"></a>功能作用</h5><p>binary log主要可以做以下几件事</p>
<ul>
<li>恢复(recovery):某些数据的恢复需要二进制日志,烈日,在一个数据库全备文件恢复后,用户可以通过二进制日志进行 point-in-time的恢复</li>
<li>复制(replication):其原理与恢复类似,通过复制和执行二进制日志使一台远程的mysql数据库(一般称为salve或standby)与另一台MySQL(一般称为master或primary)数据库进行实时同步(主从复制)</li>
<li>审计(audit):用户可以通过而金志日志中的信息来进行审计,判断是否有对数据库进行注入的攻击</li>
</ul>
<h5 id="启用和查看binlog"><a href="#启用和查看binlog" class="headerlink" title="启用和查看binlog"></a>启用和查看binlog</h5><p>早些版本mysql并没有开启binary log,但笔者使用的mysql8.0默认是开启了的</p>
<p>查看启用状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_bin&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>日志所在目录可查看命令 <code>SHOW VARIABLES LIKE &#39;log_bin_basename&#39;;</code> 文件名称为basename加上序号</p>
<p>查看binlog,使用命令 <code>mysqlbinlog</code>命令,如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog --start-position=203 binlog.000004</span><br></pre></td></tr></table></figure>

<p>如上为:查看 文件为 <code>binlog.000004</code>的binlog日志,从203行开始查看</p>
<h5 id="数据恢复"><a href="#数据恢复" class="headerlink" title="数据恢复"></a>数据恢复</h5><p>数据恢复也是使用 <code>mysqlbinlog</code> 命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog --stop-position=615 binlog.000017 | mysql -h localhost -uroot -p employees</span><br></pre></td></tr></table></figure>

<p>如上命令含义为:解析 <code>binlog.000017</code>的文件放入 主机为 localhost 的mysql服务器中的 employees数据库中去执行 <code>binlog.000017</code>开始到615行的语句,来达到数据恢复的效果</p>
<blockquote>
<p>如果线上使用数据恢复的话一般要配合数据库完备,和增量binlog来实现(因为增量binlog中可能包含误删语句,所以可能需要经过处理)</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.hongker.org/2024/04/01/mysql%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B0/Note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Link Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/mysql%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B0/Note/" class="post-title-link" itemprop="url">数据库Note</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-04-01 21:57:24 / Modified: 21:13:27" itemprop="dateCreated datePublished" datetime="2024-04-01T21:57:24+08:00">2024-04-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="创建官方示例数据库"><a href="#创建官方示例数据库" class="headerlink" title="创建官方示例数据库"></a>创建官方示例数据库</h3><p>进入地址<br><a target="_blank" rel="noopener" href="http://dev.mysql/com/doc">http://dev.mysql/com/doc</a><br>或：<a target="_blank" rel="noopener" href="https://github.com/datacharmer/test_db">https://github.com/datacharmer/test_db</a></p>
<p>下载解压</p>
<p>根据github提示操作即可<br>进入解压后的目录。进入mysql命令行<br>执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source employees.sql</span><br></pre></td></tr></table></figure>
<p>即可完成基础表的安装</p>
<p>employees 表有30w数据<br>salaries 表有300w数据</p>
<h3 id="配置文件my-cnf"><a href="#配置文件my-cnf" class="headerlink" title="配置文件my.cnf"></a>配置文件my.cnf</h3><p>my.cnf为数据库的配置文件</p>
<p>使用以下命令查看，mysql是从哪里读取配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql--help |grep my.cnf</span><br></pre></td></tr></table></figure>
<p>一般的，linux在&#x2F;etc&#x2F;my.cnf下<br>windows的在安装目录下，或没有配置文件，使用默认的配置文件</p>
<blockquote>
<p>另外，windows下可能是 .cnf或 .ini 结尾，如同一项有多个不同配置，则后面的配置会覆盖前面的配置</p>
</blockquote>
<h3 id="缓存命中率"><a href="#缓存命中率" class="headerlink" title="缓存命中率"></a>缓存命中率</h3><p>缓存命中率是一个极其重要的调优参数<br>在InnoDB 1.2 版本后可以在information_schema数据库的INNODB_BUFFER_POOL_STATS表来查看缓存池的使用状态，其中HIT_RATE为缓存命中率</p>
<blockquote>
<p>HIT_RATE参数通常情况下不会低于95%<br>如果过低可能有全表扫描sql引起了LRU(Latest Recent Used)列表被污染的问题</p>
</blockquote>
<h3 id="聚集索引与非聚集索引"><a href="#聚集索引与非聚集索引" class="headerlink" title="聚集索引与非聚集索引"></a>聚集索引与非聚集索引</h3><h4 id="聚集索引"><a href="#聚集索引" class="headerlink" title="聚集索引"></a>聚集索引</h4><p>聚集（clustered）索引，也叫聚簇索引。<br>mysql默认主键就是聚集索引,如没有主键,则系统会自动创建一个隐含列作为表的聚集索引。</p>
<blockquote>
<p>定义：数据行的物理顺序与列值（一般是主键的那一列）的逻辑顺序相同，一个表中只能拥有一个聚集索引。</p>
</blockquote>
<h4 id="非聚集索引"><a href="#非聚集索引" class="headerlink" title="非聚集索引"></a>非聚集索引</h4><p>非聚集（unclustered）索引。</p>
<blockquote>
<p>定义：该索引中索引的逻辑顺序与磁盘上行的物理存储顺序不同，一个表中可以拥有多个非聚集索引。</p>
</blockquote>
<h4 id="离散性"><a href="#离散性" class="headerlink" title="离散性"></a>离散性</h4><p>离散性,就是不均匀分布</p>
<h3 id="配置主从同步"><a href="#配置主从同步" class="headerlink" title="配置主从同步"></a>配置主从同步</h3><h4 id="配置节点"><a href="#配置节点" class="headerlink" title="配置节点"></a>配置节点</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Mysql服务的唯一编号 每个mysql服务Id需唯一</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># 开启binlog,虽然 现在的版本默认都会开启,不过这个会设置binlog的文件名称</span></span><br><span class="line"><span class="attr">log-bin</span>=<span class="string">mysql-bin</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意,以上为master节点需要的配置,从节点也需要配置server-id,且不能一致<br>如为复制文件过来的,可能需要查看数据库basedata目录,auto.cnf文件是否一样<br>如果一致,则需要删除此文件后重启数据库(会自动生成)</p>
</blockquote>
<h5 id="创建主节点同步账号"><a href="#创建主节点同步账号" class="headerlink" title="创建主节点同步账号"></a>创建主节点同步账号</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建同步使用账号, %表示允许所有ip登录, IDENTIFIED BY 后的是登录密码</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> `db_sync`@`<span class="operator">%</span>` IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="comment">-- 分配同步权限</span></span><br><span class="line"><span class="keyword">GRANT</span> Replication Slave <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> `db_sync`@`<span class="operator">%</span>`;</span><br><span class="line"><span class="comment">-- 若同步时出现异常 Authentication plugin &#x27;caching_sha2_password&#x27; reported error: Authentication requires secure connection. Error_code: MY-002061</span></span><br><span class="line"><span class="comment">-- 则执行以下sql</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;db_sync&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新权限</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询主节点binlog位置,用于子节点同步位置</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br></pre></td></tr></table></figure>

<h5 id="从节点执行同步"><a href="#从节点执行同步" class="headerlink" title="从节点执行同步"></a>从节点执行同步</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看server id,节点id不能一致,</span></span><br><span class="line"><span class="comment">-- 如为复制文件过来的,可能需要查看数据库basedata目录,auto.cnf文件是否一样</span></span><br><span class="line"><span class="comment">-- 如果一致,则需要删除此文件后重启数据库(会自动生成)</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;server_id&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 先停止主从同步</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置master信息</span></span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span> </span><br><span class="line">MASTER_HOST <span class="operator">=</span> <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">MASTER_USER <span class="operator">=</span> <span class="string">&#x27;db_sync&#x27;</span>,</span><br><span class="line">MASTER_PASSWORD <span class="operator">=</span> <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">MASTER_LOG_FILE <span class="operator">=</span> <span class="string">&#x27;mysql-bin.000003&#x27;</span>,</span><br><span class="line">MASTER_LOG_POS <span class="operator">=</span> <span class="number">8495</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 启用同步</span></span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看同步状态</span></span><br><span class="line"><span class="comment">-- 需要 Slave_IO_Running 和 Slave_SQL_Running都为 true才说明 主从同步正常</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.hongker.org/2024/04/01/linux/%E5%AE%89%E8%A3%85ubuntu%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Link Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/linux/%E5%AE%89%E8%A3%85ubuntu%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">安装ubuntu集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-04-01 21:57:24 / Modified: 21:12:44" itemprop="dateCreated datePublished" datetime="2024-04-01T21:57:24+08:00">2024-04-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li><p>下载镜像</p>
</li>
<li><p>安装ubuntu,网络模式选择 <code>nat模式</code> (共享主机ip)</p>
</li>
<li><p>关闭防火墙</p>
</li>
</ol>
<ul>
<li><p>查看防火墙状态</p>
   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw status</span><br></pre></td></tr></table></figure>
</li>
<li><p>开启防火墙</p>
   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw enable</span><br></pre></td></tr></table></figure></li>
<li><p>关闭防火墙</p>
   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw disable</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="4">
<li>更换 <code>apt-get</code> 源<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure>
  替换为以下</li>
</ol>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial main</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial main</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates main</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial universe</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security main</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security main</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security universe</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security universe</span><br></pre></td></tr></table></figure>

<p>  更新apt-get源</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>安装常用命令</p>
<ol>
<li><p>vim</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install vim-gtk</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.hongker.org/2024/04/01/%E7%AE%A1%E7%A8%8B%EF%BC%9A%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%87%E8%83%BD%E9%92%A5%E5%8C%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Link Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/%E7%AE%A1%E7%A8%8B%EF%BC%9A%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%87%E8%83%BD%E9%92%A5%E5%8C%99/" class="post-title-link" itemprop="url">管程：并发编程的万能钥匙</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-04-01 21:57:24 / Modified: 21:10:36" itemprop="dateCreated datePublished" datetime="2024-04-01T21:57:24+08:00">2024-04-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>操作系统原理课程告诉过我们，用信号量能解决所有并发问题，</p>
<p>后来我们发现不是。<strong>Java 采用的是管程技术（Monitor）</strong>，</p>
<p>synchronized 关键字及 wait()、notify()、notifyAll() 这三个方法都是管程的组成部分。</p>
<p>而<strong>管程和信号量是等价的，所谓等价指的是用管程能够实现信号量，也能用信号量实现管程</strong>。</p>
<p>但是管程更容易使用，所以 Java 选择了管程。</p>
<h2 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h2><p>管程，对应的英文是 Monitor，很多 Java 领域的同学都喜欢将其翻译成“监视器”，这是直译。</p>
<p>操作系统领域一般都翻译成“管程”，这个是意译,本文中统一使用管程来称呼</p>
<p><strong>所谓管程，指的是管理共享变量以及对共享变量的操作过程，让他们支持并发。翻译为 Java 领域的语言，就是管理类的成员变量和成员方法，让这个类是线程安全的</strong></p>
<h2 id="管程模型"><a href="#管程模型" class="headerlink" title="管程模型"></a>管程模型</h2><p>在管程的发展史上，先后出现过三种不同的管程模型，</p>
<p>分别是：<strong>Hasen 模型、Hoare 模型和 MESA 模型。</strong></p>
<p>其中，现在<strong>MESA 模型应用最广，并且 Java 管程的实现参考的也是 MESA 模型</strong>。所以今天我们重点介绍一下 MESA 模型。</p>
<ol>
<li><h3 id="Hasen-模型"><a href="#Hasen-模型" class="headerlink" title="Hasen 模型"></a>Hasen 模型</h3><p>要求 notify() 放在代码的最后，这样 T2 通知完 T1 后，T2 就结束了，然后 T1 再执行，这样就能保证同一时刻只有一个线程执行。</p>
<p><strong>要求notify()放在代码的最后面</strong></p>
</li>
<li><h3 id="Hoare-模型"><a href="#Hoare-模型" class="headerlink" title="Hoare 模型"></a>Hoare 模型</h3><p>T2 通知完 T1 后，T2 阻塞，T1 马上执行；等 T1 执行完，再唤醒 T2，也能保证同一时刻只有一个线程执行。但是相比 Hasen 模型，T2 多了一次阻塞唤醒操作。</p>
<p><strong>使用等待阻塞，来实现，多了一次阻塞唤醒操作</strong></p>
</li>
<li><h3 id="MESA-管程"><a href="#MESA-管程" class="headerlink" title="MESA 管程"></a>MESA 管程</h3><p>T2 通知完 T1 后，T2 还是会接着执行，T1 并不立即执行，仅仅是从条件变量的等待队列进到入口等待队列里面。这样做的好处是 notify() 不用放到代码的最后，T2 也没有多余的阻塞唤醒操作。但是也有个副作用，就是当 T1 再次执行的时候，可能曾经满足的条件，现在已经不满足了，所以需要以循环方式检验条件变量。</p>
<ol>
<li>在java中，每个加锁的对象都绑定着一个管程（监视器）</li>
<li>线程访问加锁对象，就是去拥有一个监视器的过程。如一个病人去门诊室看医生，医生是共享资源，门锁锁定医生，病人去看医生，就是访问医生这个共享资源，门诊室其实是监视器（管程）。</li>
<li>所有线程访问共享资源，都需要先拥有监视器。就像所有病人看病都需要先拥有进入门诊室的资格。</li>
<li>监视器至少有两个等待队列。一个是进入监视器的等待队列一个是条件变量对应的等待队列。后者可以有多个。就像一个病人进入门诊室诊断后，需要去验血，那么它需要去抽血室排队等待。另外一个病人心脏不舒服，需要去拍胸片，去拍摄室等待。</li>
<li>监视器要求的条件满足后，位于条件变量下等待的线程需要重新在门诊室门外排队，等待进入监视器。就像抽血的那位，抽完后，拿到了化验单，然后，重新回到门诊室等待，然后进入看病，然后退出，医生通知下一位进入。</li>
</ol>
</li>
</ol>
<p><strong>总结起来就是，管程就是一个对象监视器。任何线程想要访问该资源，就要排队进入监控范围。进入之后，接受检查，不符合条件，则要继续等待，直到被通知，然后继续进入监视器。</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.hongker.org/2024/04/01/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97Disruptor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Link Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97Disruptor/" class="post-title-link" itemprop="url">高性能队列Disruptor</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-04-01 21:57:24 / Modified: 21:10:36" itemprop="dateCreated datePublished" datetime="2024-04-01T21:57:24+08:00">2024-04-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><strong>Disruptor 是一款高性能的有界内存队列</strong>，目前应用非常广泛，Log4j2、Spring Messaging、HBase、Storm 都用到了 Disruptor，那 Disruptor 的性能为什么这么高呢？Disruptor 项目团队曾经写过一篇论文，详细解释了其原因，可以总结为如下：</p>
<ol>
<li>内存分配更加合理，使用 RingBuffer 数据结构，数组元素在初始化时一次性全部创建，提升缓存命中率；对象循环利用，避免频繁 GC。</li>
<li>能够避免伪共享，提升缓存利用率。</li>
<li>采用无锁算法，避免频繁加锁、解锁的性能消耗。</li>
<li>支持批量消费，消费者可以无锁方式消费多个消息。</li>
</ol>
<h3 id="高效利用CPU缓存，从局部性原理出发"><a href="#高效利用CPU缓存，从局部性原理出发" class="headerlink" title="高效利用CPU缓存，从局部性原理出发"></a>高效利用CPU缓存，从局部性原理出发</h3><p>Disruptor中的体现是RingBuffer，那么它是 如何提升性能的呢</p>
<p>Java SDK 中 ArrayBlockingQueue 使用<strong>数组</strong>作为底层的数据存储，而 Disruptor 是使用 <strong>RingBuffer</strong> 作为数据存储。RingBuffer 本质上也是数组，所以仅仅将数据存储从数组换成 RingBuffer 并不能提升性能，但是 Disruptor 在 RingBuffer 的基础上还做了很多优化，其中一项优化就是和内存分配有关的。</p>
<h4 id="局部性原理"><a href="#局部性原理" class="headerlink" title="局部性原理"></a>局部性原理</h4><p>简单来讲，程序的局部性原理指的是在一段时间内程序的执行会限定在一个局部范围内。这里的“局部性”可以从两个方面来理解，<br><strong>一个是时间局部性，另一个是空间局部性。</strong></p>
<p>时间局部性指的是程序中的某条指令一旦被执行，不久之后这条指令很可能再次被执行；如果某条数据被访问，不久之后这条数据很可能再次被访问。</p>
<p>而空间局部性是指某块内存一旦被访问，不久之后这块内存附近的内存也很可能被访问。</p>
<h4 id="通过利用局部性原理来利用CPU缓存"><a href="#通过利用局部性原理来利用CPU缓存" class="headerlink" title="通过利用局部性原理来利用CPU缓存"></a>通过利用局部性原理来利用CPU缓存</h4><p>CPU 的缓存就利用了程序的局部性原理：CPU 从内存中加载数据 X 时，会将数据 X 缓存在高速缓存 Cache 中，实际上 CPU 缓存 X 的同时，还缓存了 X 周围的数据，因为根据程序具备局部性原理，X 周围的数据也很有可能被访问。</p>
<p><strong>从另外一个角度来看，如果程序能够很好地体现出局部性原理，也就能更好地利用 CPU 的缓存，从而提升程序的性能。</strong></p>
<h3 id="避免低效的CPU缓存-避免“伪共享”"><a href="#避免低效的CPU缓存-避免“伪共享”" class="headerlink" title="避免低效的CPU缓存,避免“伪共享”"></a>避免低效的CPU缓存,避免“伪共享”</h3><p>高效利用 Cache，能够大大提升性能，所以要努力构建能够高效利用 Cache 的内存结构。而从另外一个角度看，<strong>努力避免不能高效利用 Cache 的内存结构也同样重要</strong>。</p>
<p>有一种叫做“伪共享（False sharing）”的内存布局就会使 Cache 失效，那什么是“伪共享”呢？</p>
<p><strong>伪共享和 CPU 内部的 Cache 有关，Cache 内部是按照缓存行（Cache Line）管理的，缓存行的大小通常是 64 个字节</strong>；CPU 从内存中加载数据 X，会同时加载 X 后面（64-size(X)）个字节的数据。</p>
<p><strong>伪共享指的是由于共享缓存行导致缓存无效的场景</strong>。</p>
<h4 id="解决方案：缓存行填充"><a href="#解决方案：缓存行填充" class="headerlink" title="解决方案：缓存行填充"></a>解决方案：缓存行填充</h4><p>方案很简单，每个变量独占一个缓存行、不共享缓存行就可以了</p>
<p>比如想让 takeIndex 独占一个缓存行，可以在 takeIndex 的前后各填充 56 个字节，这样</p>
<blockquote>
<p>takeIndex 为Long 类型，占8个字节，所以前后各填充56个字节，就可以保证 这个Long类型 一定独占一格缓存行</p>
<p><strong>Java 8 中，提供了避免伪共享的注解：@sun.misc.Contended</strong>，通过这个注解就能轻松避免伪共享</p>
<p>需要设置 JVM 参数 -XX:-RestrictContended。</p>
<p><strong>不过避免伪共享是以牺牲内存为代价</strong>的，所以具体使用的时候还是需要仔细斟酌。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.hongker.org/2024/04/01/Netty/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Link Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 泽仁's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/Netty/" class="post-title-link" itemprop="url">Netty</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-04-01 21:57:24 / Modified: 21:10:36" itemprop="dateCreated datePublished" datetime="2024-04-01T21:57:24+08:00">2024-04-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Netty是一个异步事件驱动的网络应用框架</p>
<p>快速开发可维护的高性能协议服务器和客户端。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>本质: 网络应用程序框架</p>
<p>实现： 异步、事件驱动</p>
<p>特性:  高性能、可维护、快速开发</p>
<p>用途：开发 服务器和客户端</p>
<blockquote>
<p>Netty 2014 年，开始开发，至今2020年，已经维护了16年</p>
<p>相比于jdk的nio，Netty功能更丰富，更稳定，也没有jdk的nio那么多BUG</p>
</blockquote>
<h3 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h3><p>以下为Netty官网上的一张Netty结构组成图片，</p>
<p><img src="https://netty.io/images/components.png" alt="img"></p>
<h4 id="主要底层实现"><a href="#主要底层实现" class="headerlink" title="主要底层实现"></a>主要底层实现</h4><p>零复制的 Byte Buffer</p>
<p>通用的通信层API</p>
<p>可扩展的事件模型</p>
<h4 id="支持的传输层"><a href="#支持的传输层" class="headerlink" title="支持的传输层"></a>支持的传输层</h4><ol>
<li><p>Socket(Tcp)</p>
</li>
<li><p>Datagram(UDP)</p>
</li>
<li><p>Tunner(Http)</p>
</li>
<li><p>In-VM (Pipe)</p>
</li>
</ol>
<h3 id="Reactor-模式"><a href="#Reactor-模式" class="headerlink" title="Reactor 模式"></a>Reactor 模式</h3><p>下面是 Reactor 模式的类结构图，其中 Handle 指的是 I&#x2F;O 句柄，在 Java 网络编程里，它本质上就是一个网络连接。Event Handler 很容易理解，就是一个事件处理器，其中 handle_event() 方法处理 I&#x2F;O 事件，也就是每个 Event Handler 处理一个 I&#x2F;O Handle；get_handle() 方法可以返回这个 I&#x2F;O 的 Handle。Synchronous Event Demultiplexer 可以理解为操作系统提供的 I&#x2F;O 多路复用 API，例如 POSIX 标准里的 select() 以及 Linux 里面的 epoll()。</p>
<p><img src="https://static001.geekbang.org/resource/image/a7/40/a7ba3c8d6c49e50d9288baf0c03fa240.png" alt="img"></p>
<p>Reactor 模式的核心自然是 Reactor 这个类，</p>
<p>其中 register_handler() 和 remove_handler() 这两个方法可以注册和删除一个事件处理器；</p>
<p>handle_events() 方式是核心，也是 Reactor 模式的发动机，</p>
<p>这个方法的核心逻辑如下：首先通过同步事件多路选择器提供的 select() 方法监听网络事件，当有网络事件就绪后，就遍历事件处理器来处理该网络事件。</p>
<p>由于网络事件是源源不断的，所以在主程序中启动 Reactor 模式，需要以 while(true){} 的方式调用 handle_events() 方法。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Link Sun</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
